apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

configMapGenerator:
  - name: git-config-map
    literals:
      - gitops_repo=https://github.com/senthilredhat/declarative-openshift.git
      - cluster_name=managementCluster
      - targetRevision=pr-46

generatorOptions:
  disableNameSuffixHash: true

resources:
  - subscription.yaml
  - cluster-rolebinding.yaml
  - argocd.yaml

helmGlobals:
  chartHome: ./

helmCharts:
  - name: rosa-hcp-application
  - name: integration-application


replacements:
- source:
    kind: ConfigMap
    name:  git-config-map
    fieldPath: data.gitops_repo
  targets:
  - select:
      kind: ArgoCD
      name: openshift-gitops
    fieldPaths:
      - spec.repo.env.[name=INFRA_GITOPS_REPO].value
      - spec.repo.sidecarContainers.[name=setenv-plugin].env.[name=INFRA_GITOPS_REPO].value
  - select:
      kind: Application
    fieldPaths:
      - spec.source.repoURL
- source:
    kind: ConfigMap
    name:  git-config-map
    fieldPath: data.cluster_name
  targets:
  - select:
      kind: ArgoCD
      name: openshift-gitops
    fieldPaths:
      - spec.repo.env.[name=CLUSTER_NAME].value
      - spec.repo.sidecarContainers.[name=setenv-plugin].env.[name=CLUSTER_NAME].value
- source:
    kind: ConfigMap
    name:  git-config-map
    fieldPath: data.targetRevision
  targets:
  - select:
      kind: Application
    fieldPaths:
      - spec.source.targetRevision


